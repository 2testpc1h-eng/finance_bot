from aiogram import Router, F
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    FSInputFile,
)
from finance_bot.keyboards.reports_kb import (
    reports_main_kb,
    overview_kb_for_type,
    back_only_kb,
)
from finance_bot.utils import parse_period, display_date
from finance_bot import database_helpers as dbh

import matplotlib.pyplot as plt
import tempfile
import os

router = Router()


@router.message(F.text == "üìä –û—Ç—á—ë—Ç")
async def reports_menu_msg(msg: Message):
    await msg.answer("üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞:", reply_markup=reports_main_kb())

@router.message(F.text == "üìà –ì—Ä–∞—Ñ–∏–∫")
async def reports_chart_msg(msg: Message):
    await msg.answer("üìà –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞:", reply_markup=reports_main_kb())



# –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã
USER_REPORT_STATE: dict[int, dict] = {}
USER_GRAPH_STATE: dict[int, dict] = {}
CLEAR_CONTEXT: dict[int, dict] = {}


# ---------- –ú–ï–ù–Æ –û–¢–ß–Å–¢–û–í ----------

@router.message(F.text.in_(("üìä –û—Ç—á–µ—Ç", "üìä –û—Ç—á—ë—Ç", "–û—Ç—á–µ—Ç—ã", "–û—Ç—á—ë—Ç—ã")))
async def open_reports_menu(message: Message):
    await message.answer(
        "üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞:",
        reply_markup=reports_main_kb()
    )


@router.callback_query(F.data.startswith("report|"))
async def handle_report_menu(call: CallbackQuery):
    await call.answer()
    _, action = call.data.split("|", 1)

    if action in ("income", "expense", "balance"):
        USER_REPORT_STATE[call.from_user.id] = {"type": action}
        await call.message.edit_text(
            "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:\n"
            "DD.MM.YYYY - DD.MM.YYYY\n"
            "–∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–≤—Å—ë¬ª"
        )


@router.message(lambda msg: msg.from_user.id in USER_REPORT_STATE)
async def handle_report_period(message: Message):
    user_id = message.from_user.id
    state = USER_REPORT_STATE.pop(user_id)

    text = message.text.strip().lower()
    if text in ("–≤—Å—ë", "–≤—Å–µ", "–≤—Å—ë –≤—Ä–µ–º—è", "–≤—Å–µ –≤—Ä–µ–º—è"):
        period = None
    else:
        start, end = parse_period(message.text)
        if not start:
            await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–∏–æ–¥–∞")
            return
        period = (start, end)

    rtype = state["type"]
    CLEAR_CONTEXT[user_id] = {"type": rtype, "period": period}

    if rtype in ("income", "expense"):
        sums = dbh.sums_by_categories(user_id, rtype, period)
        if not sums:
            await message.answer("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥.")
            return

        total = sum(sums.values())
        lines = [
            f"üìä –û—Ç—á—ë—Ç –ø–æ {'–¥–æ—Ö–æ–¥–∞–º' if rtype == 'income' else '—Ä–∞—Å—Ö–æ–¥–∞–º'}",
            f"–ü–µ—Ä–∏–æ–¥: {display_date(period[0])} ‚Äî {display_date(period[1])}" if period else "–ü–µ—Ä–∏–æ–¥: –≤—Å—ë –≤—Ä–µ–º—è",
            ""
        ]

        for c, v in sums.items():
            lines.append(f"‚Ä¢ {c}: {v:.2f} ‚ÇΩ")

        lines.append(f"\n–ò—Ç–æ–≥–æ: {total:.2f} ‚ÇΩ")

        await message.answer(
            "\n".join(lines),
            reply_markup=overview_kb_for_type(rtype)
        )

    elif rtype == "balance":
        inc = dbh.get_total_by_type(user_id, "income", period)
        exp = dbh.get_total_by_type(user_id, "expense", period)
        await message.answer(
            "üí∞ –ë–∞–ª–∞–Ω—Å\n"
            f"{'–ü–µ—Ä–∏–æ–¥: –≤—Å—ë –≤—Ä–µ–º—è' if not period else f'–ü–µ—Ä–∏–æ–¥: {display_date(period[0])} ‚Äî {display_date(period[1])}'}\n\n"
            f"–î–æ—Ö–æ–¥—ã: {inc:.2f} ‚ÇΩ\n"
            f"–†–∞—Å—Ö–æ–¥—ã: {exp:.2f} ‚ÇΩ\n"
            f"–ò—Ç–æ–≥–æ: {inc - exp:.2f} ‚ÇΩ"
        )


# ---------- –°–£–ú–ú–ê –í–°–ï–• ----------

@router.callback_query(F.data.startswith("sum_all|"))
async def sum_all_handler(call: CallbackQuery):
    await call.answer()
    user_id = call.from_user.id
    _, rtype = call.data.split("|", 1)

    total = dbh.get_total_by_type(user_id, rtype, None)
    title = "–¥–æ—Ö–æ–¥–æ–≤" if rtype == "income" else "—Ä–∞—Å—Ö–æ–¥–æ–≤"

    await call.message.edit_text(
        f"üí∞ –°—É–º–º–∞ –≤—Å–µ—Ö {title}:\n\n<b>{total:.2f} ‚ÇΩ</b>",
        reply_markup=back_only_kb(),
        parse_mode="HTML"
    )


@router.callback_query(F.data == "reports_back")
async def reports_back(call: CallbackQuery):
    await call.answer()
    await call.message.edit_text(
        "üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞:",
        reply_markup=reports_main_kb()
    )


# ---------- –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–• ----------

@router.callback_query(F.data.startswith("clear|"))
async def clear_menu(call: CallbackQuery):
    await call.answer()
    _, rtype = call.data.split("|", 1)
    uid = call.from_user.id
    ctx = CLEAR_CONTEXT.get(uid)

    if ctx and ctx.get("type") == rtype and ctx.get("period") is not None:
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥",
                callback_data=f"clear_confirm|{rtype}|period"
            )],
            [InlineKeyboardButton(
                text="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è",
                callback_data=f"clear_confirm|{rtype}|all"
            )],
            [InlineKeyboardButton(text="–û—Ç–º–µ–Ω–∞", callback_data="reports_back")]
        ])
        await call.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ —É–¥–∞–ª–∏—Ç—å:", reply_markup=kb)
        return

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è",
            callback_data=f"clear_confirm|{rtype}|all"
        )],
        [InlineKeyboardButton(text="–û—Ç–º–µ–Ω–∞", callback_data="reports_back")]
    ])
    await call.message.edit_text("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ:", reply_markup=kb)


@router.callback_query(F.data.startswith("clear_confirm|"))
async def clear_confirm(call: CallbackQuery):
    await call.answer()
    user_id = call.from_user.id
    _, rtype, mode = call.data.split("|", 2)
    ctx = CLEAR_CONTEXT.get(user_id, {})

    if mode == "period":
        period = ctx.get("period")
        if not period:
            await call.message.edit_text("‚ùå –ü–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        deleted = dbh.delete_by_type_and_period(user_id, rtype, period)
        CLEAR_CONTEXT.pop(user_id, None)

        await call.message.edit_text(
            f"‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥: {deleted}",
            reply_markup=reports_main_kb()
        )
        return

    if mode == "all":
        deleted = dbh.delete_by_type_all_time(user_id, rtype)
        CLEAR_CONTEXT.pop(user_id, None)

        await call.message.edit_text(
            f"‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π (–≤—Å—ë –≤—Ä–µ–º—è): {deleted}",
            reply_markup=reports_main_kb()
        )


# ---------- –ì–†–ê–§–ò–ö ----------

@router.message(F.text.in_(("üìà –ì—Ä–∞—Ñ–∏–∫", "–ì—Ä–∞—Ñ–∏–∫")))
async def graph_menu(message: Message):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìà –î–æ—Ö–æ–¥—ã", callback_data="graph|income")],
        [InlineKeyboardButton(text="üìâ –†–∞—Å—Ö–æ–¥—ã", callback_data="graph|expense")],
        [InlineKeyboardButton(text="üìù –û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫", callback_data="graph|both")],
    ])
    await message.answer("üìà –ß—Ç–æ —Å—Ç—Ä–æ–∏–º?", reply_markup=kb)


@router.callback_query(F.data.startswith("graph|"))
async def graph_type(call: CallbackQuery):
    await call.answer()
    USER_GRAPH_STATE[call.from_user.id] = {"type": call.data.split("|")[1]}
    await call.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:\nDD.MM.YYYY - DD.MM.YYYY\n–∏–ª–∏ ¬´–≤—Å—ë¬ª"
    )


@router.message(lambda msg: msg.from_user.id in USER_GRAPH_STATE)
async def build_graph(message: Message):
    user_id = message.from_user.id
    state = USER_GRAPH_STATE.pop(user_id)

    text = message.text.strip().lower()
    if text in ("–≤—Å—ë", "–≤—Å–µ", "–≤—Å—ë –≤—Ä–µ–º—è", "–≤—Å–µ –≤—Ä–µ–º—è"):
        period = None
    else:
        start, end = parse_period(message.text)
        if not start:
            await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–∏–æ–¥–∞")
            return
        period = (start, end)

    
    # –ü–æ—Å—Ç—Ä–æ–∏–º —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–æ–ª–±—á–∞—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø–æ –º–µ—Å—è—Ü–∞–º (–î–æ—Ö–æ–¥/–†–∞—Å—Ö–æ–¥)
    import sqlite3
    conn = dbh.get_conn()
    cur = conn.cursor()

    params = [user_id]
    q_inc = "SELECT substr(date,1,7) as month, SUM(amount) FROM operations WHERE user_id = ? AND type = 'income'"
    q_exp = "SELECT substr(date,1,7) as month, SUM(amount) FROM operations WHERE user_id = ? AND type = 'expense'"

    if period:
        start_iso = period[0].strftime("%Y-%m-%d")
        end_iso = period[1].strftime("%Y-%m-%d")
        q_inc += " AND date BETWEEN ? AND ?"
        q_exp += " AND date BETWEEN ? AND ?"
        params = [user_id, start_iso, end_iso]
        cur.execute(q_inc + " GROUP BY month ORDER BY month", params)
    else:
        cur.execute(q_inc + " GROUP BY month ORDER BY month", (user_id,))
    inc_rows = cur.fetchall()

    if period:
        cur.execute(q_exp + " GROUP BY month ORDER BY month", params)
    else:
        cur.execute(q_exp + " GROUP BY month ORDER BY month", (user_id,))
    exp_rows = cur.fetchall()
    conn.close()

    # Convert to dicts
    inc_map = {r[0]: float(r[1]) for r in inc_rows if r[0] is not None}
    exp_map = {r[0]: float(r[1]) for r in exp_rows if r[0] is not None}

    months = sorted(set(list(inc_map.keys()) + list(exp_map.keys())))
    if not months:
        await message.answer("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.")
        return

    income_vals = [inc_map.get(m, 0.0) for m in months]
    expense_vals = [exp_map.get(m, 0.0) for m in months]

    import numpy as _np
    x = _np.arange(len(months))
    width = 0.35

    plt.figure(figsize=(12,6))
    plt.bar(x - width/2, income_vals, width, label='–î–æ—Ö–æ–¥')
    plt.bar(x + width/2, expense_vals, width, label='–†–∞—Å—Ö–æ–¥')
    plt.xticks(x, [m.replace('-', '.') for m in months], rotation=45, ha='right')
    plt.ylabel("–°—É–º–º–∞")
    plt.title("–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º")
    plt.legend()
    plt.tight_layout()
    tmp = tempfile.NamedTemporaryFile(delete=False, suffix=".png")
    tmp.close()
    plt.savefig(tmp.name)
    plt.close()

    try:
        # –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ FSInputFile (–∏–∑ –ø—É—Ç–∏) ‚Äî —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
        from aiogram.types import FSInputFile
        await message.answer_photo(
            photo=FSInputFile(tmp.name),
            caption="üìà –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫"
        )
    except Exception:
        # fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫–∞–∫ —Å—Ç—Ä–æ–∫—É (aiogram —Ç–æ–∂–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç str)
        try:
            await message.answer_photo(photo=tmp.name, caption="üìà –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫")
        except Exception as e:
            await message.answer(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞: {e}")

    # –ù–µ —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –º–≥–Ω–æ–≤–µ–Ω–Ω–æ ‚Äî –¥–∞—ë–º aiogram –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –Ω–∞ Windows.
    import asyncio
    async def _del_later(path):
        await asyncio.sleep(2)
        try:
            os.unlink(path)
        except Exception:
            pass
    try:
        asyncio.create_task(_del_later(tmp.name))
    except Exception:
        # –µ—Å–ª–∏ asyncio.create_task –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –ø–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å —Å—Ä–∞–∑—É (–ø–ª–æ—Ö–æ, –Ω–æ fallback)
        try:
            os.unlink(tmp.name)
        except Exception:
            pass

# --- Dynamic handlers for report/chart buttons added to support categories from DB ---
from finance_bot.keyboards.inline_reports import categories_kb as _categories_kb
from aiogram.exceptions import TelegramForbiddenError

@router.callback_query(F.data == "report_chart_cat")
async def show_category_chart_menu(call: CallbackQuery):
    await call.answer()
    try:
        kb = _categories_kb(call.from_user.id)
        await call.message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞:", reply_markup=kb)
    except TelegramForbiddenError:
        # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
        return
    except Exception as e:
        await call.message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.")

@router.callback_query(F.data == "report_dates")
async def show_report_dates(call: CallbackQuery):
    await call.answer()
    try:
        await call.message.answer("–§—É–Ω–∫—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –ø–æ –¥–∞—Ç–∞–º –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ UI. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.", reply_markup=back_only_kb())
    except TelegramForbiddenError:
        return


# Handlers for reply-keyboard buttons
@router.message(F.text == "üìä –û—Ç—á—ë—Ç")
async def reports_menu_msg(msg: Message):
    await msg.answer("üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞:", reply_markup=reports_main_kb())

@router.message(F.text == "üìà –ì—Ä–∞—Ñ–∏–∫")
async def reports_chart_msg(msg: Message):
    # show inline keyboard with chart options (dates/chart)
    from finance_bot.keyboards.inline_reports import reports_kb as _reports_kb
    await msg.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:", reply_markup=_reports_kb)

# Handler for main report type buttons (inline)
@router.callback_query(F.data.startswith("report|"))
async def report_type_handler(call: CallbackQuery):
    await call.answer()
    parts = call.data.split("|", 1)
    if len(parts) < 2:
        await call.answer("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")
        return
    type_ = parts[1]
    try:
        await call.message.answer(f"üìä –û—Ç—á—ë—Ç: {type_.capitalize()}", reply_markup=overview_kb_for_type(type_))
    except Exception as e:
        await call.message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ—Ç—á—ë—Ç–∞.")
