from aiogram import Router, F
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    FSInputFile,
)
from finance_bot.keyboards.reports_kb import (
    reports_main_kb,
    overview_kb_for_type,
    back_only_kb,
)
from finance_bot.utils import parse_period, display_date
from finance_bot import database_helpers as dbh

import matplotlib.pyplot as plt
import tempfile
import os

router = Router()

# –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã
USER_REPORT_STATE: dict[int, dict] = {}
USER_GRAPH_STATE: dict[int, dict] = {}
CLEAR_CONTEXT: dict[int, dict] = {}


# ---------- –ú–ï–ù–Æ –û–¢–ß–Å–¢–û–í ----------

@router.message(F.text.in_(("üìä –û—Ç—á–µ—Ç", "üìä –û—Ç—á—ë—Ç", "–û—Ç—á–µ—Ç—ã", "–û—Ç—á—ë—Ç—ã")))
async def open_reports_menu(message: Message):
    await message.answer(
        "üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞:",
        reply_markup=reports_main_kb()
    )


@router.callback_query(F.data.startswith("report|"))
async def handle_report_menu(call: CallbackQuery):
    await call.answer()
    _, action = call.data.split("|", 1)

    if action in ("income", "expense", "balance"):
        USER_REPORT_STATE[call.from_user.id] = {"type": action}
        await call.message.edit_text(
            "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:\n"
            "DD.MM.YYYY - DD.MM.YYYY\n"
            "–∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–≤—Å—ë¬ª"
        )


@router.message(lambda msg: msg.from_user.id in USER_REPORT_STATE)
async def handle_report_period(message: Message):
    user_id = message.from_user.id
    state = USER_REPORT_STATE.pop(user_id)

    text = message.text.strip().lower()
    if text in ("–≤—Å—ë", "–≤—Å–µ", "–≤—Å—ë –≤—Ä–µ–º—è", "–≤—Å–µ –≤—Ä–µ–º—è"):
        period = None
    else:
        start, end = parse_period(message.text)
        if not start:
            await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–∏–æ–¥–∞")
            return
        period = (start, end)

    rtype = state["type"]
    CLEAR_CONTEXT[user_id] = {"type": rtype, "period": period}

    if rtype in ("income", "expense"):
        sums = dbh.sums_by_categories(user_id, rtype, period)
        if not sums:
            await message.answer("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥.")
            return

        total = sum(sums.values())
        lines = [
            f"üìä –û—Ç—á—ë—Ç –ø–æ {'–¥–æ—Ö–æ–¥–∞–º' if rtype == 'income' else '—Ä–∞—Å—Ö–æ–¥–∞–º'}",
            f"–ü–µ—Ä–∏–æ–¥: {display_date(period[0])} ‚Äî {display_date(period[1])}" if period else "–ü–µ—Ä–∏–æ–¥: –≤—Å—ë –≤—Ä–µ–º—è",
            ""
        ]

        for c, v in sums.items():
            lines.append(f"‚Ä¢ {c}: {v:.2f} ‚ÇΩ")

        lines.append(f"\n–ò—Ç–æ–≥–æ: {total:.2f} ‚ÇΩ")

        await message.answer(
            "\n".join(lines),
            reply_markup=overview_kb_for_type(rtype)
        )

    elif rtype == "balance":
        inc = dbh.get_total_by_type(user_id, "income", period)
        exp = dbh.get_total_by_type(user_id, "expense", period)
        await message.answer(
            "üí∞ –ë–∞–ª–∞–Ω—Å\n"
            f"{'–ü–µ—Ä–∏–æ–¥: –≤—Å—ë –≤—Ä–µ–º—è' if not period else f'–ü–µ—Ä–∏–æ–¥: {display_date(period[0])} ‚Äî {display_date(period[1])}'}\n\n"
            f"–î–æ—Ö–æ–¥—ã: {inc:.2f} ‚ÇΩ\n"
            f"–†–∞—Å—Ö–æ–¥—ã: {exp:.2f} ‚ÇΩ\n"
            f"–ò—Ç–æ–≥–æ: {inc - exp:.2f} ‚ÇΩ"
        )


# ---------- –°–£–ú–ú–ê –í–°–ï–• ----------

@router.callback_query(F.data.startswith("sum_all|"))
async def sum_all_handler(call: CallbackQuery):
    await call.answer()
    user_id = call.from_user.id
    _, rtype = call.data.split("|", 1)

    total = dbh.get_total_by_type(user_id, rtype, None)
    title = "–¥–æ—Ö–æ–¥–æ–≤" if rtype == "income" else "—Ä–∞—Å—Ö–æ–¥–æ–≤"

    await call.message.edit_text(
        f"üí∞ –°—É–º–º–∞ –≤—Å–µ—Ö {title}:\n\n<b>{total:.2f} ‚ÇΩ</b>",
        reply_markup=back_only_kb(),
        parse_mode="HTML"
    )


@router.callback_query(F.data == "reports_back")
async def reports_back(call: CallbackQuery):
    await call.answer()
    await call.message.edit_text(
        "üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞:",
        reply_markup=reports_main_kb()
    )


# ---------- –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–• ----------

@router.callback_query(F.data.startswith("clear|"))
async def clear_menu(call: CallbackQuery):
    await call.answer()
    _, rtype = call.data.split("|", 1)
    uid = call.from_user.id
    ctx = CLEAR_CONTEXT.get(uid)

    if ctx and ctx.get("type") == rtype and ctx.get("period") is not None:
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥",
                callback_data=f"clear_confirm|{rtype}|period"
            )],
            [InlineKeyboardButton(
                text="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è",
                callback_data=f"clear_confirm|{rtype}|all"
            )],
            [InlineKeyboardButton(text="–û—Ç–º–µ–Ω–∞", callback_data="reports_back")]
        ])
        await call.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ —É–¥–∞–ª–∏—Ç—å:", reply_markup=kb)
        return

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è",
            callback_data=f"clear_confirm|{rtype}|all"
        )],
        [InlineKeyboardButton(text="–û—Ç–º–µ–Ω–∞", callback_data="reports_back")]
    ])
    await call.message.edit_text("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ:", reply_markup=kb)


@router.callback_query(F.data.startswith("clear_confirm|"))
async def clear_confirm(call: CallbackQuery):
    await call.answer()
    user_id = call.from_user.id
    _, rtype, mode = call.data.split("|", 2)
    ctx = CLEAR_CONTEXT.get(user_id, {})

    if mode == "period":
        period = ctx.get("period")
        if not period:
            await call.message.edit_text("‚ùå –ü–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        deleted = dbh.delete_by_type_and_period(user_id, rtype, period)
        CLEAR_CONTEXT.pop(user_id, None)

        await call.message.edit_text(
            f"‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥: {deleted}",
            reply_markup=reports_main_kb()
        )
        return

    if mode == "all":
        deleted = dbh.delete_by_type_all_time(user_id, rtype)
        CLEAR_CONTEXT.pop(user_id, None)

        await call.message.edit_text(
            f"‚úÖ –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π (–≤—Å—ë –≤—Ä–µ–º—è): {deleted}",
            reply_markup=reports_main_kb()
        )


# ---------- –ì–†–ê–§–ò–ö ----------

@router.message(F.text.in_(("üìà –ì—Ä–∞—Ñ–∏–∫", "–ì—Ä–∞—Ñ–∏–∫")))
async def graph_menu(message: Message):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìà –î–æ—Ö–æ–¥—ã", callback_data="graph|income")],
        [InlineKeyboardButton(text="üìâ –†–∞—Å—Ö–æ–¥—ã", callback_data="graph|expense")],
        [InlineKeyboardButton(text="üìù –û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫", callback_data="graph|both")],
    ])
    await message.answer("üìà –ß—Ç–æ —Å—Ç—Ä–æ–∏–º?", reply_markup=kb)


@router.callback_query(F.data.startswith("graph|"))
async def graph_type(call: CallbackQuery):
    await call.answer()
    USER_GRAPH_STATE[call.from_user.id] = {"type": call.data.split("|")[1]}
    await call.message.edit_text(
        "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:\nDD.MM.YYYY - DD.MM.YYYY\n–∏–ª–∏ ¬´–≤—Å—ë¬ª"
    )


@router.message(lambda msg: msg.from_user.id in USER_GRAPH_STATE)
async def build_graph(message: Message):
    user_id = message.from_user.id
    state = USER_GRAPH_STATE.pop(user_id)

    text = message.text.strip().lower()
    if text in ("–≤—Å—ë", "–≤—Å–µ", "–≤—Å—ë –≤—Ä–µ–º—è", "–≤—Å–µ –≤—Ä–µ–º—è"):
        period = None
    else:
        start, end = parse_period(message.text)
        if not start:
            await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–∏–æ–¥–∞")
            return
        period = (start, end)

    plt.figure(figsize=(9, 5))

    if state["type"] in ("income", "both"):
        d, v = dbh.get_daily_totals(user_id, "income", period)
        plt.plot(d, v, label="–î–æ—Ö–æ–¥—ã")

    if state["type"] in ("expense", "both"):
        d, v = dbh.get_daily_totals(user_id, "expense", period)
        plt.plot(d, v, label="–†–∞—Å—Ö–æ–¥—ã")

    plt.grid(True)
    plt.legend()
    plt.xlabel("–î–∞—Ç–∞")
    plt.ylabel("–°—É–º–º–∞")
    plt.title("–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –¥–∏–Ω–∞–º–∏–∫–∞")

    tmp = tempfile.NamedTemporaryFile(delete=False, suffix=".png")
    plt.savefig(tmp.name)
    plt.close()

    await message.answer_photo(
        photo=FSInputFile(tmp.name),
        caption="üìà –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫"
    )

    os.unlink(tmp.name)
